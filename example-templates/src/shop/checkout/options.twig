{% extends '[[folderName]]/_private/layouts' %}

{# @var cart \craft\commerce\elements\Order #}

{% block main %}

  {% if not cart.getCustomer() %}
    {% redirect '[[folderName]]/checkout/email' %}
  {% endif %}

  {% if not cart.gateway %}
    {% redirect '[[folderName]]/checkout/payment-method' %}
  {% endif %}

  <div class="md:flex md:-mx-8" [[hx-disable]]>
    <div class="md:w-2/3 md:px-8">

      <h1 class="font-bold text-xl">
        {{- 'Options'|t -}}
      </h1>

      <form action="" method="post">
        {{ csrfInput() }}
        {{ actionInput('commerce/cart/update-cart') }}
        {{ redirectInput(siteUrl('shop/checkout/payment')) }}
        {{ successMessageInput('Options saved.') }}

        {% set user = cart.email ? craft.users.email(cart.email).one() : null %}
        {% if not user or not user.getIsCredentialed() %}
          <div class="mt-3">
            <label for="registerUserOnOrderComplete">
              {{ hiddenInput('registerUserOnOrderComplete', false) }}
              {{ input('checkbox', 'registerUserOnOrderComplete', 1, {
                id: 'registerUserOnOrderComplete'
              }) }}
              {{ 'Create my account after ordering'|t }}
            </label>
            <div>
              {{ _self.docs('Registering a user on order complete.', 'https://docs.craftcms.com/commerce/api/v4/craft-commerce-elements-order.html#registeruseronordercomplete') }}
            </div>
          </div>
        {% endif %}

        {% set saveAddressCheckboxesShown = false %}
        {% if cart.billingAddressId and not cart.sourceBillingAddressId %}
          {% set saveAddressCheckboxesShown = true %}
          <div class="mt-3 js-save-address {{ cart.getCustomer() and cart.getCustomer().getIsCredentialed() ? '' : 'hidden' }}">
            <label for="saveBillingAddressOnOrderComplete">
              {{ hiddenInput('saveBillingAddressOnOrderComplete', false) }}
              {{ input('checkbox', 'saveBillingAddressOnOrderComplete', 1, {
                id: 'saveBillingAddressOnOrderComplete',
                checked: cart.saveBillingAddressOnOrderComplete,
              }) }}
              {{ 'Save billing address on order complete'|t }}
            </label>
          </div>
        {% endif %}

        {% if cart.shippingAddressId and not cart.sourceShippingAddressId %}
          <div class="mt-3 js-save-address {{ cart.getCustomer() and cart.getCustomer().getIsCredentialed() ? '' : 'hidden' }}">
            {% set saveAddressCheckboxesShown = true %}
            <label for="saveShippingAddressOnOrderComplete">
              {{ hiddenInput('saveShippingAddressOnOrderComplete', false) }}
              {{ input('checkbox', 'saveShippingAddressOnOrderComplete', 1, {
                id: 'saveShippingAddressOnOrderComplete',
                checked: cart.saveShippingAddressOnOrderComplete,
              }) }}
              {{ 'Save shipping address on order complete'|t }}
            </label>
          </div>
        {% endif %}

        {% if saveAddressCheckboxesShown %}
          <div class="js-save-address {{ cart.getCustomer() and cart.getCustomer().getIsCredentialed() ? '' : 'hidden' }}">
            {{ _self.docs('Saving addresses on order complete.', '#') }}
          </div>
        {% endif %}

        <div class="mt-6 flex justify-end">
          {{ tag('button', {
            type: 'submit',
            name: 'submit',
            class: '[[classes.btn.base]] [[classes.btn.mainColor]]',
            text: 'Next'|t
          }) }}
        </div>
      </form>
    </div>

    <div class="mt-8 md:w-1/3 md:px-8 md:mt-0">
      {{ include('[[folderName]]/checkout/_includes/order-summary', {
        showShippingAddress: true,
        showShippingMethod: true
      }) }}
    </div>
  </div>

  {% js %}
    const $registerCheckbox = document.querySelector('#registerUserOnOrderComplete');

    if ($registerCheckbox) {
      $registerCheckbox.addEventListener('change', () => {
          // if the register checkbox is checked make sure the save address checkboxes are visible
          const saveAddressBoxes = document.querySelectorAll('.js-save-address');
          if ($registerCheckbox.checked) {
              saveAddressBoxes.forEach((box) => {
                  box.classList.remove('hidden');
              });
          } else {
              saveAddressBoxes.forEach((box) => {
                  box.classList.add('hidden');
              });
          }
      });
    }
  {% endjs %}
{% endblock %}
